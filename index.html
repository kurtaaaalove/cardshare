<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>分享處理頁面</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      text-align: center;
      padding: 20px;
      margin: 0;
      background-color: #f0f4f8; 
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      min-height: 95vh;
      box-sizing: border-box;
    }
    .page-marker { 
      font-size: 22px;
      font-weight: bold;
      color: #D32F2F; 
      border: 2px dashed #D32F2F;
      padding: 10px 15px;
      margin-bottom: 20px;
      background-color: #FFCDD2;
    }
    .message-container {
      padding: 25px;
      background-color: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      width: 90%;
      max-width: 400px;
    }
    .message {
      font-size: 18px;
      color: #333;
      margin-top: 0;
      line-height: 1.6;
    }
    .error-message {
      color: #D32F2F;
      font-weight: bold;
    }
    .success-message {
      color: #388E3C;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="page-marker">這是「分享處理專用」頁面 (部署於 cardshare/index.html)</div>

  <div class="message-container">
    <p class="message" id="statusMessage">正在初始化分享服務...</p>
  </div>

  <script>
    async function initializeShareRedirect() {
      const statusMessageElement = document.getElementById('statusMessage');
      const liffId = "2007344981-byP9NanG"; // 此頁面專用的 LIFF ID

      try {
        statusMessageElement.textContent = "正在初始化 LIFF (ID: " + liffId + ")...";
        await liff.init({ liffId: liffId });
        statusMessageElement.textContent = "LIFF 初始化成功。";

        if (!liff.isLoggedIn()) {
          statusMessageElement.innerHTML += "<br>提示：使用者未登入。";
          console.warn("User not logged in. ShareTargetPicker might handle login or fail.");
        }

        const urlParams = new URLSearchParams(window.location.search);
        const shareTarget = urlParams.get('target');
        statusMessageElement.innerHTML += "<br>讀取分享目標：" + (shareTarget || "未提供");

        if (!shareTarget) {
          statusMessageElement.innerHTML = '<span class="error-message">錯誤：缺少分享目標參數 (target)。</span><br>此視窗將在3秒後關閉。';
          setTimeout(() => { if (liff.isInClient()) liff.closeWindow(); }, 3000);
          return;
        }

        let targetFile = ''; // 將直接是檔案名稱
        let altText = '';
        
        // ⭐ JSON 檔案現在位於相對於此 index.html 的同一目錄下 (在 cardshare 專案內) ⭐
        if (shareTarget === 'ksdigi') {
          targetFile = 'ksdigi.json'; 
          altText = 'KSDIGI 名片';
        } else if (shareTarget === 'daka') {
          targetFile = 'daka.json';
          altText = 'DAKA 名片';
        } else if (shareTarget === 'kktl') {
          targetFile = 'kktl.json';
          altText = '越境食旅 名片';
        } else {
          statusMessageElement.innerHTML = `<span class="error-message">錯誤：未知的分享目標 (${shareTarget})。</span><br>此視窗將在3秒後關閉。`;
          setTimeout(() => { if (liff.isInClient()) liff.closeWindow(); }, 3000);
          return;
        }

        statusMessageElement.innerHTML += `<br>準備分享 ${altText} (來源: ${targetFile})...`;
        
        const response = await fetch(targetFile); 
        if (!response.ok) {
          throw new Error(`讀取 ${targetFile} 失敗 (狀態：${response.status})`);
        }
        const flexMessageContents = await response.json();
        statusMessageElement.innerHTML += "<br>Flex Message 內容讀取成功。";

        if (liff.isInClient()) {
          statusMessageElement.innerHTML += "<br>正在啟動分享選擇器...";
          await liff.shareTargetPicker([{
            type: "flex",
            altText: altText,
            contents: flexMessageContents
          }]);
          statusMessageElement.innerHTML = '<span class="success-message">分享已啟動！</span><br>正在關閉視窗...';
          liff.closeWindow();
        } else {
          statusMessageElement.innerHTML = '<span class="error-message">錯誤：此分享功能僅限於 LINE App 內操作。</span><br>請在 LINE App 中開啟此連結。';
        }

      } catch (err) {
        console.error("Share redirect error:", err);
        let errorMessage = err.toString();
        if (err.name && err.message) {
            errorMessage = `${err.name}: ${err.message}`;
        }
        statusMessageElement.innerHTML = `<div class="error-message">分享過程中發生錯誤：<br>${errorMessage}</div>`;
      }
    }
    initializeShareRedirect();
  </script>
</body>
</html>